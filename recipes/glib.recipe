# -*- Mode: Python -*- vi:si:et:sw=4:sts=4:ts=4:syntax=python

class Recipe(recipe.Recipe):
    name = 'glib'
    version = '2.32.1'
    commit = 'sdk-release-sdk-2012.5'
    licenses = [License.LGPLv2Plus]
    configure_sh = 'sh autogen.sh'
    deps = ['libffi', 'zlib']
    can_use_configure_cache = False
    platform_deps = {Platform.WINDOWS: ['libiconv', 'gettext'],
                     Platform.DARWIN: ['libiconv', 'gettext']}

    files_libs = [
        'libglib-2.0', 'libgio-2.0', 'libgmodule-2.0', 'libgobject-2.0',
        'libgthread-2.0']
    files_bins = ['gsettings', 'gdbus', 'gio-querymodules', 'glib-compile-schemas']
    files_gio = ['lib/gio/modules']
    files_devel = [
        'bin/glib-gettextize%(bext)s',
        'bin/glib-mkenums%(bext)s',
        'bin/glib-compile-resources%(bext)s',
        'bin/glib-genmarshal%(bext)s',
        'bin/gresource%(bext)s',
        'lib/glib-2.0/include/glibconfig.h',
        'lib/pkgconfig/gio-2.0.pc',
        'lib/pkgconfig/glib-2.0.pc',
        'lib/pkgconfig/gmodule-2.0.pc',
        'lib/pkgconfig/gmodule-export-2.0.pc',
        'lib/pkgconfig/gmodule-no-export-2.0.pc',
        'lib/pkgconfig/gobject-2.0.pc',
        'lib/pkgconfig/gthread-2.0.pc',
        'include/glib-2.0']
    platform_files_devel = {
        Platform.WINDOWS: ['lib/pkgconfig/gio-windows-2.0.pc', 'include/gio-win32-2.0'],
        Platform.LINUX: ['lib/pkgconfig/gio-unix-2.0.pc', 'include/gio-unix-2.0'],
        Platform.DARWIN: ['lib/pkgconfig/gio-unix-2.0.pc', 'include/gio-unix-2.0'],
    }

    files_lang = ['glib20']

    def _gio_flags(self, path1=None, path2=None, use_old_uri_scheme=False):
        flags = ''
        def escape(path):
            return '\\\\\\\"%s\\\\\\\"' % path
        if path1 is not None:
            flags += ' -DGST_SDK_GLIB_GIO_DISTRO_GIO_MODULE_PATH=%s' % escape(path1)
        if path2 is not None:
            flags += ' -DGST_SDK_GLIB_GIO_DISTRO_GIO_MODULE_PATH2=%s' % escape(path2)
        if use_old_uri_scheme:
            flags += ' -DGST_SDK_GLIB_GIO_OLD_URI_SCHEME_HANDLERS=1'
        return flags
         
    def prepare(self):
        if self.config.target_platform == Platform.WINDOWS:
            self.configure_options = '--with-libiconv=gnu'
        elif self.config.target_platform == Platform.DARWIN:
            self.config_sh = 'CFLAGS="$CFLAGS -DHAVE_STRNDUP" ./configure'
        elif self.config.target_platform == Platform.LINUX:
            if self.config.target_distro == Distro.DEBIAN and self.config.target_distro_version in [DistroVersion.DEBIAN_SQUEEZE, DistroVersion.UBUNTU_LUCID, DistroVersion.UBUNTU_MAVERICK]:
                self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/gio/modules/', None, True)
            elif self.config.target_distro == Distro.DEBIAN and self.config.target_distro_version in [DistroVersion.UBUNTU_NATTY, DistroVersion.UBUNTU_ONEIRIC, DistroVersion.UBUNTU_PRECISE]:
                if self.config.target_arch == Architecture.X86:
                    self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/gio/modules/', '/usr/lib/i386-linux-gnu/gio/modules')
                elif self.config.target_arch == Architecture.X86_64:
                    self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/gio/modules/', '/usr/lib/x86_64-linux-gnu/gio/modules')
            elif self.config.target_distro == Distro.DEBIAN and self.config.target_distro_version in [DistroVersion.DEBIAN_WHEEZY]:
                if self.config.target_arch == Architecture.X86:
                    self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/i386-linux-gnu/gio/modules')
                elif self.config.target_arch == Architecture.X86_64:
                    self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/x86_64-linux-gnu/gio/modules')
            elif self.config.target_distro == Distro.REDHAT:
                if self.config.target_distro_version in [DistroVersion.FEDORA_16, DistroVersion.FEDORA_17]:
                    if self.config.target_arch == Architecture.X86:
                        self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/gio/modules')
                    elif self.config.target_arch == Architecture.X86_64:
                        self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib64/gio/modules/')
                else:
                    self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/gio/modules/')
            elif self.config.target_distro == Distro.SUSE:
                if self.config.target_arch == Architecture.X86:
                    self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib/gio/modules')
                elif self.config.target_arch == Architecture.X86_64:
                    self.config_sh = 'CFLAGS="%s" ./configure' % self._gio_flags('/usr/lib64/gio/modules')
            else:
                from cerbero.errors import FatalError
                raise FatalError(_("Add specific for other Linux distributions here"))

    def post_install(self):
        import shutil
        if self.config.target_platform == Platform.WINDOWS:
            shutil.copy(os.path.join(self.build_dir, 'glib', 'glibconfig.h.win32'),
                        os.path.join(self.config.prefix, 'lib', 'glib-2.0',
                                     'include', 'glibconfig.h'))
